name: AI Python PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  python-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Collect changed Python files
        id: files
        run: |
          git fetch origin main
          git diff --name-only origin/main...HEAD | grep '\.py$' > files.txt || true
          echo "FILES=$(cat files.txt | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Read Python files content
        id: code
        run: |
          echo "CODE_CONTENT<<EOF" >> $GITHUB_ENV
          for file in $FILES; do
            echo "File: $file" >> $GITHUB_ENV
            echo "----------------" >> $GITHUB_ENV
            cat "$file" >> $GITHUB_ENV
            echo -e "\n" >> $GITHUB_ENV
          done
          echo "EOF" >> $GITHUB_ENV

      - name: Call Azure OpenAI
        run: |
          cat <<EOF > review.json
          {
            "messages": [
              {
                "role": "system",
                "content": "You are a senior Python code reviewer."
              },
              {
                "role": "user",
                "content": |
                  Review the following Python code ONLY for:
                  - Syntax errors
                  - Indentation issues
                  - Invalid or missing imports
                  - Obvious runtime errors

                  DO NOT suggest refactoring or optimization.

                  Respond in EXACTLY one of these formats:

                  ❌ Issues Found:
                  - File:
                    Line:
                    Issue:
                    Fix:

                  OR

                  ✅ No syntax issues found. Code is safe to merge.

                  Code:
                  ${CODE_CONTENT}
              }
            ],
            "temperature": 0
          }
          EOF

          curl -s -X POST "${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
            -H "Content-Type: application/json" \
            -H "api-key: ${{ secrets.AZURE_OPENAI_API_KEY }}" \
            -d @review.json > response.json

      - name: Extract AI response
        run: |
          jq -r '.choices[0].message.content' response.json > comment.txt

      - name: Post AI comment to Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.txt', 'utf8');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
