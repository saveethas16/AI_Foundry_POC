name: AI Python PR Review

on:
  pull_request:
    types: [opened, synchronize]

# ðŸ”´ REQUIRED permissions to comment on PR
permissions:
  contents: read
  pull-requests: write

jobs:
  python-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Collect changed Python files
        run: |
          git diff --name-only origin/${{ github.base_ref }} \
            | grep '\.py$' > python_files.txt || true

          if [ ! -s python_files.txt ]; then
            echo "No Python files changed"
            exit 0
          fi

          mkdir -p review
          for file in $(cat python_files.txt); do
            echo "### File: $file" >> review/input.txt
            sed -n '1,300p' "$file" >> review/input.txt
            echo "" >> review/input.txt
          done

      - name: Call Azure AI Foundry (Python syntax check)
        env:
          ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
        run: |
          PROMPT=$(cat <<EOF
You are a senior Python code reviewer.

Review the code ONLY for:
- Syntax errors
- Indentation issues
- Invalid or missing imports
- Obvious runtime errors

DO NOT suggest refactoring or optimization.

Respond in EXACTLY one of these formats:

âŒ Issues Found:
- File:
  Line:
  Issue:
  Fix:

OR

âœ… No syntax issues found. Code is safe to merge.

Code:
$(cat review/input.txt)
EOF
)

          curl -s -X POST \
            "$ENDPOINT/openai/deployments/$DEPLOYMENT/chat/completions?api-version=2024-05-01-preview" \
            -H "Content-Type: application/json" \
            -H "api-key: $API_KEY" \
            -d "{
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a strict Python syntax checker\"},
                {\"role\": \"user\", \"content\": \"$PROMPT\"}
              ],
              \"temperature\": 0.1
            }" > review/output.json

      - name: Post AI review comment to Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT=$(jq -r '.choices[0].message.content' review/output.json)

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "$(jq -n --arg body "$COMMENT" '{body: $body}')"
